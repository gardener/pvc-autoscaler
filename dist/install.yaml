---
apiVersion: v1
kind: Namespace
metadata:
  labels:
    app.kubernetes.io/component: manager
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: system
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: namespace
    app.kubernetes.io/part-of: pvc-autoscaler
    control-plane: controller-manager
  name: pvc-autoscaler-system
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    cert-manager.io/inject-ca-from: pvc-autoscaler-system/pvc-autoscaler-serving-cert
    controller-gen.kubebuilder.io/version: v0.16.4
  name: persistentvolumeclaimautoscalers.autoscaling.gardener.cloud
spec:
  conversion:
    strategy: Webhook
    webhook:
      clientConfig:
        service:
          name: pvc-autoscaler-webhook-service
          namespace: pvc-autoscaler-system
          path: /convert
      conversionReviewVersions:
      - v1
  group: autoscaling.gardener.cloud
  names:
    kind: PersistentVolumeClaimAutoscaler
    listKind: PersistentVolumeClaimAutoscalerList
    plural: persistentvolumeclaimautoscalers
    shortNames:
    - pvca
    singular: persistentvolumeclaimautoscaler
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.targetRef.name
      name: Target
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          PersistentVolumeClaimAutoscaler is the Schema for the
          persistentvolumeclaimautoscalers API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              PersistentVolumeClaimAutoscalerSpec defines the desired state of
              PersistentVolumeClaimAutoscaler
            properties:
              targetRef:
                description: |-
                  TargetRef specifies the reference to the workload controller (e.g., StatefulSet)
                  whose PVCs will be managed by the autoscaler.
                properties:
                  apiVersion:
                    description: apiVersion is the API version of the referent
                    type: string
                  kind:
                    description: 'kind is the kind of the referent; More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
                    type: string
                  name:
                    description: 'name is the name of the referent; More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names'
                    type: string
                required:
                - kind
                - name
                type: object
                x-kubernetes-map-type: atomic
              volumePolicies:
                description: VolumePolicies defines a list of policies for autoscaling
                  PVCs.
                items:
                  description: VolumePolicy defines the autoscaling policy for a specific
                    PVC
                  properties:
                    maxCapacity:
                      anyOf:
                      - type: integer
                      - type: string
                      description: |-
                        MaxCapacity specifies the maximum capacity up to which a PVC is
                        allowed to be extended.
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    minCapacity:
                      anyOf:
                      - type: integer
                      - type: string
                      description: MinCapacity specifies the minimum capacity for
                        the PVC.
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    scaleUp:
                      description: ScaleUp defines the policy for scaling up the PVC.
                      properties:
                        cooldownDuration:
                          description: CooldownDuration specifies the duration to
                            wait before another scale-up operation.
                          type: string
                          x-kubernetes-validations:
                          - message: cooldownDuration must be greater than 0
                            rule: duration(self) > duration('0s')
                        minStepAbsolute:
                          anyOf:
                          - type: integer
                          - type: string
                          description: |-
                            MinStepAbsolute specifies the minimum absolute increase in capacity during scale-up.
                            This ensures that the capacity increase is at least this amount, regardless of the percentage.
                          pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                          x-kubernetes-int-or-string: true
                        stepPercent:
                          default: 10
                          description: StepPercent specifies the percentage increase
                            for the PVC capacity during scale-up.
                          maximum: 100
                          minimum: 1
                          type: integer
                        utilizationThresholdPercent:
                          default: 90
                          description: |-
                            UtilizationThresholdPercent specifies the threshold percentage for used space.
                            When the used space reaches or exceeds this threshold, a scale-up is triggered.
                          maximum: 100
                          minimum: 1
                          type: integer
                      required:
                      - cooldownDuration
                      - minStepAbsolute
                      type: object
                  required:
                  - maxCapacity
                  - minCapacity
                  - scaleUp
                  type: object
                maxItems: 1
                minItems: 1
                type: array
            required:
            - targetRef
            - volumePolicies
            type: object
          status:
            description: |-
              PersistentVolumeClaimAutoscalerStatus defines the observed state of
              PersistentVolumeClaimAutoscaler
            properties:
              conditions:
                description: Conditions specifies the status conditions.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              freeInodesPercentage:
                description: |-
                  FreeInodesPercentage specifies the last observed free inodes of the
                  PVC as a percentage.
                type: string
              freeSpacePercentage:
                description: |-
                  FreeSpacePercentage specifies the last observed free space of the PVC
                  as a percentage.
                type: string
              lastCheck:
                description: LastCheck specifies the last time the PVC was checked
                  by the controller.
                format: date-time
                type: string
              newSize:
                anyOf:
                - type: integer
                - type: string
                description: NewSize specifies the new size to which the PVC will
                  be resized.
                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                x-kubernetes-int-or-string: true
              nextCheck:
                description: |-
                  NextCheck specifies the next scheduled check of the PVC by the
                  controller.
                format: date-time
                type: string
              prevSize:
                anyOf:
                - type: integer
                - type: string
                description: |-
                  PrevSize specifies the previous .status.capacity.storage value of the
                  PVC, just before resizing it.
                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                x-kubernetes-int-or-string: true
              usedInodesPercentage:
                description: |-
                  UsedInodesPercentage specifies the last observed used inodes of the
                  PVC as a percentage.
                type: string
              usedSpacePercentage:
                description: |-
                  UsedSpacePercentage specifies the last observed used space of the PVC
                  as a percentage.
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: controller-manager-sa
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: serviceaccount
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-controller-manager
  namespace: pvc-autoscaler-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: leader-election-role
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: role
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-leader-election-role
  namespace: pvc-autoscaler-system
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: pvc-autoscaler
  name: pvc-autoscaler-autoscaling-persistentvolumeclaimautoscaler-editor-role
rules:
- apiGroups:
  - autoscaling.gardener.cloud
  resources:
  - persistentvolumeclaimautoscalers
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - autoscaling.gardener.cloud
  resources:
  - persistentvolumeclaimautoscalers/status
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: pvc-autoscaler
  name: pvc-autoscaler-autoscaling-persistentvolumeclaimautoscaler-viewer-role
rules:
- apiGroups:
  - autoscaling.gardener.cloud
  resources:
  - persistentvolumeclaimautoscalers
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - autoscaling.gardener.cloud
  resources:
  - persistentvolumeclaimautoscalers/status
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pvc-autoscaler-manager-role
rules:
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims
  verbs:
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims/status
  verbs:
  - get
- apiGroups:
  - autoscaling.gardener.cloud
  resources:
  - persistentvolumeclaimautoscalers
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - autoscaling.gardener.cloud
  resources:
  - persistentvolumeclaimautoscalers/finalizers
  verbs:
  - update
- apiGroups:
  - autoscaling.gardener.cloud
  resources:
  - persistentvolumeclaimautoscalers/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - storage.k8s.io
  resources:
  - storageclasses
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: metrics-reader
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrole
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-metrics-reader
rules:
- nonResourceURLs:
  - /metrics
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: proxy-role
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrole
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-proxy-role
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: leader-election-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: rolebinding
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-leader-election-rolebinding
  namespace: pvc-autoscaler-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pvc-autoscaler-leader-election-role
subjects:
- kind: ServiceAccount
  name: pvc-autoscaler-controller-manager
  namespace: pvc-autoscaler-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: manager-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrolebinding
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pvc-autoscaler-manager-role
subjects:
- kind: ServiceAccount
  name: pvc-autoscaler-controller-manager
  namespace: pvc-autoscaler-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: proxy-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrolebinding
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-proxy-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pvc-autoscaler-proxy-role
subjects:
- kind: ServiceAccount
  name: pvc-autoscaler-controller-manager
  namespace: pvc-autoscaler-system
---
apiVersion: v1
data:
  metrics.txt: |-
    # HELP kubelet_volume_stats_available_bytes Fake available bytes in volumes
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="monitoring",persistentvolumeclaim="vali-vali-0",type="fake"} 1073741824
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="vali-vali-0-test-sts-0",type="fake"} 1073741824
    kubelet_volume_stats_available_bytes{namespace="default",persistentvolumeclaim="test-pvc-2",type="fake"} 4294967296

    # HELP kubelet_volume_stats_capacity_bytes Fake capacity bytes of volumes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="monitoring",persistentvolumeclaim="vali-vali-0",type="fake"} 107374182400
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="vali-vali-0-test-sts-0",type="fake"} 107374182400
    kubelet_volume_stats_capacity_bytes{namespace="default",persistentvolumeclaim="test-pvc-2",type="fake"} 53687091200

    # HELP kubelet_volume_stats_inodes_free Fake free inodes in volumes
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="monitoring",persistentvolumeclaim="vali-vali-0",type="fake"} 65536
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="vali-vali-0-test-sts-0",type="fake"} 65536
    kubelet_volume_stats_inodes_free{namespace="default",persistentvolumeclaim="test-pvc-2",type="fake"} 262144

    # HELP kubelet_volume_stats_inodes Fake total inodes in volumes
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="monitoring",persistentvolumeclaim="vali-vali-0",type="fake"} 655360
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="vali-vali-0-test-sts-0",type="fake"} 655360
    kubelet_volume_stats_inodes{namespace="default",persistentvolumeclaim="test-pvc-2",type="fake"} 327680
  nginx.conf: "events {\n    worker_connections 1024;\n}\n\nhttp {\n    server {\n
    \       listen 8080;\n        \n        # Serve static fake Prometheus metrics
    from file\n        location /metrics {\n            add_header Content-Type text/plain;\n
    \           alias /etc/nginx/metrics.txt;\n        }\n        \n        # Health
    check endpoint\n        location /health {\n            add_header Content-Type
    text/plain;\n            return 200 'OK';\n        }\n    }\n}"
  pod_bytes_high_1Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 129023424
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 1073741824
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 65536
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 65536
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_bytes_high_1Gi{stage="2",description="bytes_high"} 1
  pod_bytes_high_2Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 260046848
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 2147483648
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 131000
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 131000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_bytes_high_2Gi{stage="4",description="bytes_high"} 1
  pod_bytes_high_3Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 0
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 3221225472
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 196000
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 196000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_bytes_high_3Gi{stage="6",description="bytes_high"} 1
  pod_bytes_low_1Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 1073741824
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 1073741824
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 65536
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 65536
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_bytes_low_1Gi{stage="1",description="bytes_low"} 1
  pod_bytes_low_2Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 1203765248
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 2147483648
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 131000
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 131000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_bytes_low_2Gi{stage="3",description="bytes_low"} 1
  pod_bytes_low_3Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 1333788672
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 3221225472
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 196000
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-1",type="fake"} 196000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_bytes_low_3Gi{stage="5",description="bytes_low"} 1
  pod_inode_high_1Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 1073741824
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 1073741824
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 5536
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 65536
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_inode_high_1Gi{stage="8",description="inode_high"} 1
  pod_inode_high_2Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 2147483648
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 2147483648
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 11000
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 131000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_inode_high_2Gi{stage="10",description="inode_high"} 1
  pod_inode_high_3Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 3221225472
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 3221225472
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 0
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 196000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_inode_high_3Gi{stage="12",description="inode_high"} 1
  pod_inode_low_1Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 1073741824
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 1073741824
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 65536
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 65536
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_inode_low_1Gi{stage="7",description="inode_low"} 1
  pod_inode_low_2Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 2147483648
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 2147483648
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 71000
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 131000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_inode_low_2Gi{stage="9",description="inode_low"} 1
  pod_inode_low_3Gi.txt: |-
    # HELP kubelet_volume_stats_available_bytes Number of available bytes in the volume
    # TYPE kubelet_volume_stats_available_bytes gauge
    kubelet_volume_stats_available_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 3221225472
    # HELP kubelet_volume_stats_capacity_bytes Total capacity of the volume in bytes
    # TYPE kubelet_volume_stats_capacity_bytes gauge
    kubelet_volume_stats_capacity_bytes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 3221225472
    # HELP kubelet_volume_stats_inodes_free Number of free inodes in the volume
    # TYPE kubelet_volume_stats_inodes_free gauge
    kubelet_volume_stats_inodes_free{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 76000
    # HELP kubelet_volume_stats_inodes Total number of inodes in the volume
    # TYPE kubelet_volume_stats_inodes gauge
    kubelet_volume_stats_inodes{namespace="pvc-autoscaler-system",persistentvolumeclaim="test-pvc-2",type="fake"} 196000
    # HELP fake_metrics_stage Current stage information
    # TYPE fake_metrics_stage gauge
    fake_metrics_pod_inode_low_3Gi{stage="11",description="inode_low"} 1
kind: ConfigMap
metadata:
  name: pvc-autoscaler-minimal-fake-metrics-config-b7f56kmbbb
  namespace: pvc-autoscaler-system
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: controller-manager-metrics-service
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: service
    app.kubernetes.io/part-of: pvc-autoscaler
    control-plane: controller-manager
  name: pvc-autoscaler-controller-manager-metrics-service
  namespace: pvc-autoscaler-system
spec:
  ports:
  - name: https
    port: 8443
    protocol: TCP
    targetPort: https
  selector:
    control-plane: controller-manager
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    networking.resources.monitoringer.cloud/from-all-seed-scrape-targets-allowed-ports: '[{"protocol":"TCP","port":8080}]'
  labels:
    app: minimal-fake-metrics-server
  name: pvc-autoscaler-minimal-fake-metrics-server
  namespace: pvc-autoscaler-system
spec:
  ports:
  - name: metrics
    port: 8080
    targetPort: 8080
  selector:
    app: minimal-fake-metrics-server
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: pvc-autoscaler
  name: pvc-autoscaler-webhook-service
  namespace: pvc-autoscaler-system
spec:
  ports:
  - port: 443
    protocol: TCP
    targetPort: 9443
  selector:
    control-plane: controller-manager
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-autoscaler-metrics-test
  namespace: pvc-autoscaler-system
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  volumeMode: Filesystem
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: manager
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: controller-manager
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: pvc-autoscaler
    app.kubernetes.io/part-of: pvc-autoscaler
    control-plane: controller-manager
  name: pvc-autoscaler-controller-manager
  namespace: pvc-autoscaler-system
spec:
  replicas: 1
  selector:
    matchLabels:
      control-plane: controller-manager
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: manager
      labels:
        control-plane: controller-manager
    spec:
      containers:
      - args:
        - --health-probe-bind-address=:8081
        - --metrics-bind-address=127.0.0.1:8080
        - --leader-elect
        - --interval=30s
        - --prometheus-address=http://kind-prometheus-kube-prome-prometheus.monitoring.svc.cluster.local:9090
        - --metrics-available-bytes-query=kubelet_volume_stats_available_bytes{type="fake"}
        - --metrics-capacity-bytes-query=kubelet_volume_stats_capacity_bytes{type="fake"}
        - --metrics-available-inodes-query=kubelet_volume_stats_inodes_free{type="fake"}
        - --metrics-capacity-inodes-query=kubelet_volume_stats_inodes{type="fake"}
        image: europe-docker.pkg.dev/gardener-project/releases/gardener/pvc-autoscaler:latest
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        name: manager
        ports:
        - containerPort: 9443
          name: webhook-server
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /tmp/k8s-webhook-server/serving-certs
          name: cert
          readOnly: true
      - args:
        - --secure-listen-address=0.0.0.0:8443
        - --upstream=http://127.0.0.1:8080/
        - --logtostderr=true
        - --v=0
        image: gcr.io/kubebuilder/kube-rbac-proxy:v0.15.0
        name: kube-rbac-proxy
        ports:
        - containerPort: 8443
          name: https
          protocol: TCP
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 5m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      securityContext:
        runAsNonRoot: true
      serviceAccountName: pvc-autoscaler-controller-manager
      terminationGracePeriodSeconds: 10
      volumes:
      - name: cert
        secret:
          defaultMode: 420
          secretName: webhook-server-cert
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: minimal-fake-metrics-server
  name: pvc-autoscaler-minimal-fake-metrics-server
  namespace: pvc-autoscaler-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: minimal-fake-metrics-server
  template:
    metadata:
      annotations:
        fake-metrics.pvc-autoscaler.io/stage: pod_bytes_low_1Gi
      labels:
        app: minimal-fake-metrics-server
    spec:
      containers:
      - image: nginx:alpine
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 20
        name: nginx
        ports:
        - containerPort: 8080
          name: metrics
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        volumeMounts:
        - mountPath: /etc/nginx/nginx.conf
          name: config
          subPath: nginx.conf
        - mountPath: /etc/nginx
          name: nginx-served-metrics
      initContainers:
      - command:
        - /bin/sh
        - -c
        - "echo \"Waiting for metrics-test-pod...\"\nchroot /host kubectl wait --for=condition=Ready
          --timeout=120s -n pvc-autoscaler-system  pod/pvc-autoscaler-metrics-test-pod
          --kubeconfig=/etc/kubernetes/admin.conf\n\necho \"Starting kubelet_volume_stats_*
          metrics validation...\"\nnode_name=$(chroot /host kubectl get nodes -o jsonpath='{.items[0].metadata.name}'
          --kubeconfig=/etc/kubernetes/admin.conf 2>/dev/null)\nmetrics_path=\"/api/v1/nodes/${node_name}/proxy/metrics\"\n\n#
          Retry logic: try every 10 seconds for up to 3 minutes\nmax_attempts=18\nattempt=1\nsuccess=false\n\nwhile
          [ $attempt -le $max_attempts ]; do\n  echo \"Attempt $attempt/$max_attempts:
          Fetching kubelet metrics...\"\n  \n  output=$(chroot /host kubectl get --raw
          \"${metrics_path}\" --kubeconfig=/etc/kubernetes/admin.conf 2>/dev/null)\n
          \ exit_status=$?\n  \n  if [ $exit_status -eq 0 ]; then\n    echo \"Successfully
          accessed kubelet metrics endpoint\"\n    if echo \"${output}\" | grep -q
          \"kubelet_volume_stats_\"; then\n      echo \"kubelet_volume_stats_* metrics
          found:\"\n      echo \"${output}\" | grep \"kubelet_volume_stats_\"\n      success=true\n
          \     break\n    else\n      echo \"kubelet_volume_stats_* metrics NOT found
          in response\"\n    fi\n  else\n    echo \"Cannot access kubelet metrics
          endpoint (exit code: $exit_status)\"\n  fi\n  \n  echo \"Waiting 10 seconds
          before next attempt...\"\n  sleep 10\n  attempt=$((attempt + 1))\ndone\n\nif
          [ \"$success\" = \"false\" ]; then\n  echo \"ERROR: Failed to find kubelet_volume_stats_*
          metrics after 3 minutes\"\n  exit 1\nfi\n\necho \"kubelet_volume_stats_*
          metrics validation completed successfully\"\n"
        image: busybox:latest
        name: metrics-verifier
        securityContext:
          privileged: true
        volumeMounts:
        - mountPath: /host
          name: host-root
          readOnly: true
      - command:
        - /bin/sh
        - -c
        - |
          echo "Multi-stage fake metrics server initializing..."

          # Get stage from downward API environment variable
          STAGE_FILE="${METRICS_STAGE}.txt"

          echo "Selected stage: ${METRICS_STAGE}"
          echo "Looking for file: ${STAGE_FILE}"

          # Check if the stage file exists
          if [ -f "/config/${STAGE_FILE}" ]; then
            echo "Found stage file: ${STAGE_FILE}"
            cp "/config/${STAGE_FILE}" "/etc/nginx/metrics.txt"
          else
            echo "ERROR: Stage file ${STAGE_FILE} not found"
            echo "Available stages:"
            ls -la /config/stage*.txt || true
            exit 1
          fi

          echo "Stage selection completed. Current stage: ${METRICS_STAGE}"
          echo "Content preview:"
          cat "/etc/nginx/metrics.txt"
        env:
        - name: METRICS_STAGE
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['fake-metrics.pvc-autoscaler.io/stage']
        image: busybox:latest
        name: stage-selector
        volumeMounts:
        - mountPath: /config
          name: config
        - mountPath: /etc/nginx
          name: nginx-served-metrics
      volumes:
      - configMap:
          name: pvc-autoscaler-minimal-fake-metrics-config-b7f56kmbbb
        name: config
      - emptyDir: {}
        name: nginx-served-metrics
      - hostPath:
          path: /
          type: Directory
        name: host-root
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  labels:
    app.kubernetes.io/component: certificate
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: serving-cert
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: certificate
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-serving-cert
  namespace: pvc-autoscaler-system
spec:
  dnsNames:
  - pvc-autoscaler-webhook-service.pvc-autoscaler-system.svc
  - pvc-autoscaler-webhook-service.pvc-autoscaler-system.svc.cluster.local
  issuerRef:
    kind: Issuer
    name: pvc-autoscaler-selfsigned-issuer
  secretName: webhook-server-cert
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: pvc-autoscaler
  name: pvc-autoscaler-selfsigned-issuer
  namespace: pvc-autoscaler-system
spec:
  selfSigned: {}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/component: metrics
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: controller-manager-metrics-monitor
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: servicemonitor
    app.kubernetes.io/part-of: pvc-autoscaler
    control-plane: controller-manager
  name: pvc-autoscaler-controller-manager-metrics-monitor
  namespace: pvc-autoscaler-system
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    path: /metrics
    port: https
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  selector:
    matchLabels:
      control-plane: controller-manager
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app: minimal-fake-metrics-server
    release: kind-prometheus
  name: pvc-autoscaler-minimal-fake-metrics-server
  namespace: pvc-autoscaler-system
spec:
  endpoints:
  - honorLabels: false
    interval: 30s
    metricRelabelings:
    - action: keep
      regex: kubelet_volume_stats_.*
      sourceLabels:
      - __name__
    - action: keep
      regex: fake
      sourceLabels:
      - type
    path: /metrics
    port: metrics
    relabelings:
    - replacement: fake-metrics-server
      targetLabel: instance
    - replacement: fake-kubelet-metrics
      targetLabel: job
    scrapeTimeout: 30s
  selector:
    matchLabels:
      app: minimal-fake-metrics-server
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: metrics-test-pod
  name: pvc-autoscaler-metrics-test-pod
  namespace: pvc-autoscaler-system
spec:
  containers:
  - command:
    - sleep
    - infinity
    image: busybox:latest
    name: metrics-test-container
    volumeMounts:
    - mountPath: /data
      name: data-volume
  restartPolicy: Always
  volumes:
  - name: data-volume
    persistentVolumeClaim:
      claimName: pvc-autoscaler-metrics-test
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  annotations:
    cert-manager.io/inject-ca-from: pvc-autoscaler-system/pvc-autoscaler-serving-cert
  labels:
    app.kubernetes.io/component: webhook
    app.kubernetes.io/created-by: pvc-autoscaler
    app.kubernetes.io/instance: validating-webhook-configuration
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: validatingwebhookconfiguration
    app.kubernetes.io/part-of: pvc-autoscaler
  name: pvc-autoscaler-validating-webhook-configuration
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: pvc-autoscaler-webhook-service
      namespace: pvc-autoscaler-system
      path: /validate-autoscaling-gardener-cloud-v1alpha1-persistentvolumeclaimautoscaler
  failurePolicy: Fail
  name: vpersistentvolumeclaimautoscaler.kb.io
  rules:
  - apiGroups:
    - autoscaling.gardener.cloud
    apiVersions:
    - v1alpha1
    operations:
    - CREATE
    - UPDATE
    - DELETE
    resources:
    - persistentvolumeclaimautoscalers
  sideEffects: None
